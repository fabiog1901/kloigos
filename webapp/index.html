<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="static/favicon.png">
  <title>Κλοηγός / Kloigos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="/style.css" />

  <!-- App code must load BEFORE Alpine initializes x-data="app()" -->
  <script defer src="/script.js"></script>

  <!-- Alpine last -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Ace Editor (YAML mode) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/mode-yaml.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-searchbox.js"></script>
</head>

<body>
  <div class="page" x-data="app()" x-init="init()">

    <header class="topbar">
      <div class="topbar-title">
        <div class="logo-pill">Κ</div>
        <div>
          <h1>Κλοηγός / Kloigos</h1>
          <div class="topbar-sub"
            x-text="view === 'dashboard' ? 'Compute units &amp; service status overview' : 'Playbooks editor'">
          </div>
        </div>
      </div>

      <div class="topbar-right">
        <a href="#" class="pill" :class="{ 'pill-accent': view === 'dashboard' }"
          @click.prevent="setView('dashboard')">Dashboard</a>

        <a href="#" class="pill" :class="{ 'pill-accent': view === 'playbooks' }"
          @click.prevent="setView('playbooks')">Playbooks</a>

        <a href="/api/docs" target="_blank" rel="noopener" aria-label="API Docs" title="API Docs (/api/docs)">
          <!-- code brackets icon -->
          <svg width="32" height="32" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="white"
              d="M8.7 16.3a1 1 0 0 1-1.4 0L3.99 13a1.5 1.5 0 0 1 0-2.12L7.3 7.7a1 1 0 1 1 1.4 1.42L5.83 12l2.87 2.88a1 1 0 0 1 0 1.42Zm6.6 0a1 1 0 0 0 1.4 0L20.01 13a1.5 1.5 0 0 0 0-2.12L16.7 7.7a1 1 0 1 0-1.4 1.42L18.17 12l-2.87 2.88a1 1 0 0 0 0 1.42ZM13.2 5.6a1 1 0 0 0-1.25.69l-3 10a1 1 0 1 0 1.92.56l3-10a1 1 0 0 0-.67-1.25Z" />
          </svg>
        </a>

        <a href="https://github.com/fabiog1901/kloigos" target="_blank" rel="noopener" aria-label="GitHub Repository"
          title="GitHub">
          <svg height="32" width="32" viewBox="0 0 16 16" aria-hidden="true">
            <path fill="white" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29
            6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49
            -2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87
            .51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02
            .08-2.12 0 0 .67-.21 2.2.82a7.65 7.65 0 0 1 2-.27c.68 0 1.36.09
            2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82
            1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48
            0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16
            8c0-4.42-3.58-8-8-8z" />
          </svg>
        </a>
      </div>
    </header>

    <!-- DASHBOARD VIEW -->
    <main class="layout" x-show="view === 'dashboard'">
      <aside class="sidebar">
        <div>
          <h2>Summary</h2>
          <div class="metric">
            <div class="metric-label">Total Compute Units</div>
            <div class="metric-value" x-text="computeUnits.length"></div>
          </div>
        </div>

        <!-- <div>
          <h2>Status</h2>
          <div class="metric">
            <div class="legend">
              <div class="legend-pill"><span class="dot dot-online"></span> Free</div>
              <div class="legend-pill"><span class="dot dot-warning"></span> Allocated</div>
              <div class="legend-pill"><span class="dot dot-muted"></span> Terminating</div>
              <div class="legend-pill"><span class="dot dot-offline"></span> Unavailable</div>
            </div>
          </div>
        </div> -->

        <div>
          <h2>Actions</h2>
          <div class="metric" style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn" @click="refreshDashboard()" :disabled="loading.list">
              <span>Refresh</span>
              <!-- <span x-show="!loading.list">Refresh</span> -->
              <!-- <span x-show="loading.list">Loading…</span> -->

            </button>

            <button class="btn" @click="openAllocateModal()">Allocate…</button>
            <button class="btn btn-warn" @click="openInitModal()">Init server…</button>
            <button class="btn btn-danger" @click="openDecommissionModal()">Decommission…</button>

            <label
              style="display:flex; align-items:center; gap:10px; font-size:12px; color: var(--muted); margin-top: 4px;">
              <input type="checkbox" x-model="autoRefreshEnabled" />
              Auto-refresh (10s)
            </label>
          </div>
        </div>
      </aside>

      <section class="main">
        <div class="main-header">
          <div class="main-header-left">
            <div class="main-title">Compute Units</div>
            <div class="main-subtitle">Live view of host allocation and status.</div>
          </div>

          <div class="main-actions">
            <input type="search" class="search-input" placeholder="Filter by hostname, owner, or service…"
              x-model="filterQuery" @input="persistFilter(); applyFilterSort();" />

            <div class="pill">Updated (UTC): <span x-text="lastUpdatedUtc"></span></div>

          </div>
        </div>

        <div class="table-container">
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th data-sort="string" :class="sortClass(0)" @click="toggleSort(0)">Deployment ID</th>
                  <th data-sort="string" :class="sortClass(1)" @click="toggleSort(1)">Compute ID</th>
                  <th data-sort="string" :class="sortClass(2)" @click="toggleSort(2)">Region</th>
                  <th data-sort="string" :class="sortClass(3)" @click="toggleSort(3)">Hostname</th>
                  <th data-sort="ip" :class="sortClass(4)" @click="toggleSort(4)">IP</th>
                  <th data-sort="number" :class="sortClass(5)" @click="toggleSort(5)">CPUs</th>
                  <!-- <th data-sort="string" :class="sortClass(6)" @click="toggleSort(6)">CPU Range</th>
                  <th data-sort="string" :class="sortClass(7)" @click="toggleSort(7)">Ports Range</th> -->
                  <th data-sort="date" :class="sortClass(8)" @click="toggleSort(8)">Started At (UTC)</th>
                  <th data-sort="string" :class="sortClass(9)" @click="toggleSort(9)">Status</th>
                  <th>Act</th>
                </tr>
              </thead>

              <tbody>
                <template x-for="row in visibleRows" :key="row.compute_id">
                  <tr>
                    <!-- deployment_id -->
                    <td>
                      <template x-if="tagValue(row, 'deployment_id')">
                        <span class="service-pill" x-text="tagValue(row,'deployment_id')"></span>
                      </template>
                    </td>

                    <!-- compute_id (click for details) -->
                    <td>
                      <!-- <button class="ip-pill" style="cursor:pointer; background: rgba(15, 23, 42, 0.9);" type="button" @click="openComputeDetails(row)" :title="'Show details for ' + row.compute_id"> -->
                      <span class="ip-pill clickable" style="cursor:pointer;" @click="openComputeDetails(row)"
                        :title="'Show details for ' + row.compute_id" x-text="row.compute_id"></span>
                      <!-- </button> -->
                    </td>

                    <!-- region-zone -->
                    <td><span x-text="(row.region || '-') + '-' + (row.zone || '-')"></span></td>

                    <!-- hostname -->
                    <td>
                      <template x-if="row.hostname">
                        <span x-text="row.hostname"></span>
                      </template>
                      <template x-if="!row.hostname"><span>-</span></template>
                    </td>

                    <!-- ip -->
                    <td><span x-text="row.ip || '-'"></span></td>

                    <!-- cpu_count -->
                    <td><span x-text="row.cpu_count"></span></td>

                    <!-- cpu_range -->
                    <!-- <td>
                      <span class="service-pill">
                        <span :title="row.cpu_list || ''" x-text="row.cpu_range || '-'"></span>
                      </span>
                    </td> -->

                    <!-- ports range -->
                    <!-- <td><span class="service-pill" x-text="row.ports_range || '-'"></span></td> -->

                    <!-- started_at -->
                    <td x-text="toUtcStringMaybe(row.started_at)"></td>

                    <!-- status -->
                    <td>
                      <span class="status" :class="statusClass(row.status)">
                        <span class="status-dot"></span>
                        <span x-text="String(row.status || 'unknown').toUpperCase()"></span>
                      </span>
                    </td>

                    <!-- actions -->
                    <td>
                      <!-- Deallocate only when ALLOCATED -->
                      <template x-if="String(row.status || '').toUpperCase() === 'ALLOCATED'">
                        <button class="icon-btn" :disabled="busyKey === row.compute_id"
                          title="Deallocate compute unit (releases the host back to the pool)"
                          @click="openDeallocateConfirm(row)">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M8 3v7m8-7v7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            <path d="M7 10h10v3a5 5 0 0 1-10 0v-3Z" stroke="currentColor" stroke-width="2"
                              stroke-linejoin="round" />
                            <path d="M12 18v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </button>
                      </template>

                      <!-- Allocate only when FREE -->
                      <template x-if="String(row.status || '').toUpperCase() === 'FREE'">
                        <button class="icon-btn" :disabled="busyKey === row.compute_id"
                          title="Allocate this compute unit" @click="openAllocateModal(row.compute_id)">
                          <!-- plus-in-circle -->
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M12 7v10M7 12h10" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                            <path d="M12 21a9 9 0 1 1 0-18a9 9 0 0 1 0 18Z" stroke="currentColor" stroke-width="2" />
                          </svg>
                        </button>
                      </template>

                      <!-- Nothing otherwise -->
                      <template
                        x-if="String(row.status || '').toUpperCase() !== 'ALLOCATED' && String(row.status || '').toUpperCase() !== 'FREE'">
                        <span style="color: var(--muted);">-</span>
                      </template>
                    </td>
                  </tr>
                </template>

                <template x-if="!loading.list && visibleRows.length === 0">
                  <tr>
                    <td colspan="11" style="padding: 18px; color: var(--muted);">No results.</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>


      </section>
    </main>

    <!-- Bottom Inspector (Dashboard only) -->
    <section class="inspector-panel" x-show="view === 'dashboard'">
      <div class="inspector-header">
        <h2 class="inspector-title">API Inspector</h2>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div class="pill" style="margin:0;">
            Base:
            <span
              style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
              x-text="apiBase"></span>
          </div>

          <div class="toggle">
            <button :class="inspectorFormat==='yaml' ? 'active' : ''"
              @click="inspectorFormat='yaml'; persistInspectorFormat()">YAML</button>
            <button :class="inspectorFormat==='json' ? 'active' : ''"
              @click="inspectorFormat='json'; persistInspectorFormat()">JSON</button>
          </div>

          <button class="btn" style="padding:7px 12px;" @click="inspector=null">CLEAR</button>
        </div>
      </div>

      <pre class="inspector-pre" x-text="inspectorText()"></pre>
    </section>

    <!-- PLAYBOOKS VIEW -->
    <main class="layout" x-show="view === 'playbooks'">
      <aside class="sidebar">
        <div>
          <h2>Summary</h2>
          <div class="metric">
            <div class="metric-label">Playbooks</div>
            <div class="metric-value" x-text="playbooks.length"></div>
          </div>
        </div>

        <div>
          <h2>Actions</h2>
          <div class="metric" style="display:flex; flex-direction:column; gap:10px;">

            <button class="btn" @click="savePlaybook()"
              :disabled="pbLoading.save || !selectedPlaybook || !pbEditorReady">
              <span x-show="!pbLoading.save">Save</span>
              <span x-show="pbLoading.save">Saving…</span>
            </button>

          </div>
        </div>

        <!-- <template x-if="pbToast.message">
          <div class="toast" :class="pbToast.ok ? 'toast-ok' : 'toast-bad'">
            <div style="font-size:12px; color: var(--muted); margin-bottom: 4px;">Playbooks</div>
            <div x-text="pbToast.message"></div>
          </div>
        </template> -->
      </aside>

      <section class="main">
        <div class="main-header">
          <div class="main-header-left">
            <div class="main-title">Playbook editor</div>
            <div class="main-subtitle">Select a playbook, edit YAML, then save.</div>
          </div>

          <div class="main-actions">
            <select class="select" x-model="selectedPlaybook" @change="onSelectPlaybook()"
              :disabled="pbLoading.list || !pbEditorReady">
              <option value="" disabled>Select playbook…</option>
              <template x-for="p in playbooks" :key="p">
                <option :value="p" x-text="p"></option>
              </template>
            </select>

          </div>
        </div>

        <div class="editor-shell">

          <div style="flex: 1 1 auto; min-height: 0;">
            <div id="aceEditor" x-ref="aceContainer" style="width:100%; height: 100%;"></div>
          </div>
        </div>

        <div class="footer">
          <span>Rendered at (UTC) <span x-text="renderedAtUtc"></span></span>
          <span>Κλοηγός playbooks</span>
        </div>
      </section>
    </main>

    <!-- Allocate Modal -->
    <div class="modal-backdrop" x-show="modal.allocate.open" x-transition @keydown.escape.window="closeAllocateModal()">
      <div class="modal" @click.outside="closeAllocateModal()">
        <div class="modal-header">
          <h3 class="modal-title">Allocate Compute Unit</h3>
          <button class="btn" style="padding:7px 12px;" @click="closeAllocateModal()">CLOSE</button>
        </div>

        <div class="modal-body">
          <div class="form-grid">
            <div class="form-row">
              <div class="label">cpu_count (optional)</div>
              <input class="input" type="number" min="1" x-model.number="modal.allocate.cpu_count"
                placeholder="default 4" />
            </div>
            <div class="form-row">
              <div class="label">region (optional)</div>
              <input class="input" x-model="modal.allocate.region" placeholder="e.g. us-east-1" />
            </div>
            <div class="form-row">
              <div class="label">zone (optional)</div>
              <input class="input" x-model="modal.allocate.zone" placeholder="e.g. us-east-1a" />
            </div>
            <div class="form-row">
              <div class="label">compute_id (optional)</div>
              <input class="input" x-model="modal.allocate.compute_id"
                placeholder="e.g. cu-123 (leave blank for any)" />
            </div>
            <div class="form-row" style="grid-column: 1 / -1;">
              <div class="label">ssh_public_key (required)</div>
              <textarea class="textarea" x-model="modal.allocate.ssh_public_key"
                placeholder="ssh-ed25519 AAAA... user@host"></textarea>
            </div>
            <div class="form-row" style="grid-column: 1 / -1;">
              <div class="label">tags (required, JSON object)</div>
              <textarea class="textarea" x-model="modal.allocate.tagsText" spellcheck="false"
                placeholder='{"deployment_id":"web_app_v1","owner":"fabio","roles":["db","worker"]}'></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn" @click="closeAllocateModal()">CANCEL</button>
          <button class="btn" :disabled="loading.allocate" @click="allocate()">
            <span x-show="!loading.allocate">ALLOCATE</span>
            <span x-show="loading.allocate">WORKING…</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Init Modal -->
    <div class="modal-backdrop" x-show="modal.init.open" x-transition @keydown.escape.window="closeInitModal()">
      <div class="modal" @click.outside="closeInitModal()">
        <div class="modal-header">
          <h3 class="modal-title">Init Server</h3>
          <button class="btn" style="padding:7px 12px;" @click="closeInitModal()">CLOSE</button>
        </div>

        <div class="modal-body">
          <div class="form-grid">
            <div class="form-row">
              <div class="label">ip</div>
              <input class="input" x-model="modal.init.ip" placeholder="10.0.0.12" />
            </div>
            <div class="form-row">
              <div class="label">hostname</div>
              <input class="input" x-model="modal.init.hostname" placeholder="server-123" />
            </div>
            <div class="form-row">
              <div class="label">region</div>
              <input class="input" x-model="modal.init.region" placeholder="us-east-1" />
            </div>
            <div class="form-row">
              <div class="label">zone</div>
              <input class="input" x-model="modal.init.zone" placeholder="us-east-1a" />
            </div>
            <div class="form-row" style="grid-column: 1 / -1;">
              <div class="label">cpu_ranges (JSON array of strings)</div>
              <textarea class="textarea" x-model="modal.init.cpuRangesText" spellcheck="false"
                placeholder='["0-3","4-7"]'></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn" @click="closeInitModal()">CANCEL</button>
          <button class="btn btn-warn" :disabled="loading.init" @click="initServer()">
            <span x-show="!loading.init">RUN INIT</span>
            <span x-show="loading.init">WORKING…</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Decommission Modal -->
    <div class="modal-backdrop" x-show="modal.decommission.open" x-transition
      @keydown.escape.window="closeDecommissionModal()">
      <div class="modal" @click.outside="closeDecommissionModal()">
        <div class="modal-header">
          <h3 class="modal-title">Decommission Server</h3>
          <button class="btn" style="padding:7px 12px;" @click="closeDecommissionModal()">CLOSE</button>
        </div>

        <div class="modal-body">
          <div style="color: var(--muted); font-size: 13px;">
            Calls <span class="ip-pill">DELETE /api/admin/decommission_server/{hostname}</span>
          </div>

          <div class="form-grid">
            <div class="form-row" style="grid-column: 1 / -1;">
              <div class="label">hostname</div>
              <input class="input" x-model="modal.decommission.hostname" placeholder="server-123" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn" @click="closeDecommissionModal()">CANCEL</button>
          <button class="btn btn-danger" :disabled="loading.decommission" @click="decommissionByHostname()">
            <span x-show="!loading.decommission">DECOMMISSION</span>
            <span x-show="loading.decommission">WORKING…</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Deallocate Confirm Modal -->
    <div class="modal-backdrop" x-show="modal.deallocateConfirm.open" x-transition
      @keydown.escape.window="closeDeallocateConfirm()">
      <div class="modal" @click.outside="closeDeallocateConfirm()">
        <div class="modal-header">
          <h3 class="modal-title">Confirm Deallocate</h3>
          <button class="btn" style="padding:7px 12px;" @click="closeDeallocateConfirm()">CLOSE</button>
        </div>

        <div class="modal-body">
          <div style="color: var(--muted); font-size: 13px; line-height: 1.5;">
            This will <span style="color:#e5f4ff;">release the compute unit back to the pool</span>.
            Any workload depending on it may be disrupted.
          </div>

          <div class="metric" style="display:grid; gap:8px;">
            <div class="metric-label">Request</div>
            <div>
              <span class="ip-pill">DELETE /api/compute_units/deallocate/<span
                  x-text="modal.deallocateConfirm.compute_id"></span></span>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <div class="pill" style="margin:0;">compute_id: <span x-text="modal.deallocateConfirm.compute_id"></span>
              </div>
              <div class="pill" style="margin:0;">hostname: <span
                  x-text="modal.deallocateConfirm.hostname || '-'"></span></div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn" @click="closeDeallocateConfirm()">CANCEL</button>
          <button class="btn btn-warn" :disabled="loading.deallocateConfirm" @click="confirmDeallocate()">
            <span x-show="!loading.deallocateConfirm">YES, DEALLOCATE</span>
            <span x-show="loading.deallocateConfirm">WORKING…</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Compute Unit Details Modal -->
    <div class="modal-backdrop" x-show="modal.computeDetails.open" x-transition
      @keydown.escape.window="closeComputeDetails()">
      <div class="modal" @click.outside="closeComputeDetails()">
        <div class="modal-header">
          <h3 class="modal-title">Compute Unit Details</h3>
          <button class="btn" style="padding:7px 12px;" @click="closeComputeDetails()">CLOSE</button>
        </div>

        <div class="modal-body" style="display:grid; gap:10px;">
          <div style="color: var(--muted); font-size: 13px;">
            Full record for <span class="ip-pill" x-text="modal.computeDetails.row?.compute_id || '-'"></span>
          </div>

          <div class="metric" style="border-color: rgba(148, 163, 184, 0.25);">
            <pre class="inspector-pre" style="max-height: 50vh; white-space: pre-wrap;"
              x-text="modal.computeDetails.row ? (inspectorFormat==='json' ? JSON.stringify(modal.computeDetails.row, null, 2) : toYaml(modal.computeDetails.row)) : ''"></pre>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn" @click="closeComputeDetails()">CLOSE</button>
        </div>
      </div>
    </div>

  </div>
</body>

</html>