<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #020617;
            --bg-elevated: #020617;
            --card: #020617;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.15);
            --border-subtle: #1f2937;
            --text: #e5e7eb;
            --muted: #9ca3af;
            --danger: #f97373;
            --danger-soft: rgba(239, 68, 68, 0.15);
            --warn: #fbbf24;
            --warn-soft: rgba(251, 191, 36, 0.15);
            --success: #34d399;
            --success-soft: rgba(52, 211, 153, 0.15);
            --radius-lg: 14px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #1f2933 0, #020617 50%, #020617 100%);
            color: var(--text);
            font-size: 16px;
            /* larger base text */
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            background: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(16px);
        }

        .topbar-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-pill {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9 45%, #020617 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.35),
                0 18px 35px rgba(15, 23, 42, 0.9);
            font-size: 20px;
            font-weight: 700;
            color: #e5f4ff;
        }

        .topbar h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }

        .topbar-sub {
            font-size: 13px;
            color: var(--muted);
        }

        .topbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--muted);
        }

        .pill-accent {
            border-color: rgba(56, 189, 248, 0.7);
            background: linear-gradient(120deg, rgba(56, 189, 248, 0.12), rgba(129, 140, 248, 0.16));
            color: #e0f2fe;
        }

        .layout {
            flex: 1 1 auto;
            display: flex;
            padding: 20px 32px 16px;
            gap: 20px;
            min-height: 0;
            /* allows inner flex children to scroll */
        }

        .sidebar {
            width: 260px;
            max-width: 100%;
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 16px 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex-shrink: 0;
        }

        .sidebar h2 {
            margin: 0 0 6px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .metric {
            background: radial-gradient(circle at 10% 0, rgba(148, 163, 184, 0.25) 0, transparent 55%),
                radial-gradient(circle at 100% 120%, rgba(37, 99, 235, 0.4) 0, transparent 55%);
            border-radius: 10px;
            padding: 12px 12px 10px;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .metric-label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 600;
        }

        .metric-sub {
            margin-top: 2px;
            font-size: 12px;
            color: var(--muted);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            margin-top: 4px;
        }

        .legend-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.45);
        }

        .dot {
            width: 9px;
            height: 9px;
            border-radius: 999px;
        }

        .dot-online {
            background: var(--success);
        }

        .dot-warning {
            background: var(--warn);
        }

        .dot-offline {
            background: var(--danger);
        }

        .main {
            flex: 1 1 auto;
            min-width: 0;
            background: var(--card);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 16px 18px 10px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* critical for inner scroll */
        }

        .main-header {
            flex-shrink: 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .main-header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .main-title {
            font-size: 18px;
            font-weight: 500;
        }

        .main-subtitle {
            font-size: 13px;
            color: var(--muted);
        }

        .main-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-input {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 999px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text);
            min-width: 220px;
        }

        .search-input::placeholder {
            color: rgba(148, 163, 184, 0.8);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.16) 0, transparent 50%);
            padding: 8px 14px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: #e5f4ff;
            cursor: pointer;
        }

        .btn:hover {
            border-color: rgba(56, 189, 248, 0.9);
        }

        /* Container that will hold the table and scroll only rows */
        .table-container {
            flex: 1 1 auto;
            min-height: 0;
            /* critical */
            display: flex;
            border-radius: 11px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 26px 60px rgba(15, 23, 42, 0.9);
            overflow: hidden;
        }

        .table-scroll {
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
            /* only rows scroll */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            /* larger table text */
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 1;
            background: linear-gradient(to bottom, #020617, #020617);
        }

        th,
        td {
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.13em;
            color: #9ca3af;
            border-bottom: 1px solid rgba(55, 65, 81, 0.9);
            cursor: default;
            user-select: none;
        }

        th[data-sort] {
            cursor: pointer;
        }

        th[data-sort]::after {
            content: "⇅";
            margin-left: 6px;
            font-size: 11px;
            opacity: 0.4;
        }

        th[data-sort].sort-asc::after {
            content: "↑";
            opacity: 0.9;
        }

        th[data-sort].sort-desc::after {
            content: "↓";
            opacity: 0.9;
        }

        tbody tr:nth-child(even) {
            background: rgba(23, 34, 60, 0.85);
        }

        tbody tr:nth-child(odd) {
            background: rgba(15, 23, 42, 0.45);
        }

        tbody tr:hover {
            background: rgba(30, 64, 175, 0.5);
        }

        td:first-child {
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }

        .status-online {
            background: var(--success-soft);
            color: var(--success);
        }

        .status-online .status-dot {
            background: var(--success);
        }

        .status-warning {
            background: var(--warn-soft);
            color: var(--warn);
        }

        .status-warning .status-dot {
            background: var(--warn);
        }

        .status-offline {
            background: var(--danger-soft);
            color: var(--danger);
        }

        .status-offline .status-dot {
            background: var(--danger);
        }

        .status-default {
            background: rgba(148, 163, 184, 0.15);
            color: var(--muted);
        }

        .status-default .status-dot {
            background: var(--muted);
        }

        .ip-pill {
            display: inline-flex;
            align-items: center;
            padding: 3px 9px;
            border-radius: 999px;
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.45);
        }

        .owner-pill {
            display: inline-flex;
            align-items: center;
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .service-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 12px;
        }

        .tag-list {
            display: flex;
            flex-direction: column;
            /* stack vertically */
            gap: 4px;
            /* space between pills */
        }

        .service-tag {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }

        .footer {
            flex-shrink: 0;
            margin-top: 10px;
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .footer span {
            opacity: 0.8;
        }

        @media (max-width: 900px) {
            .layout {
                flex-direction: column;
                padding: 16px;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main {
                order: 1;
            }

            .topbar {
                padding: 12px 16px;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <header class="topbar">
            <div class="topbar-title">
                <div class="logo-pill">π</div>
                <div>
                    <h1>{{ title }}</h1>
                    <div class="topbar-sub">
                        Host &amp; service status overview
                    </div>
                </div>
            </div>
            <div class="topbar-right">
                <div class="pill">
                    Updated: {{ last_updated or "–" }}
                </div>
                <div class="pill pill-accent">
                    {{ hosts|length }} Hosts
                </div>
            </div>
        </header>

        <main class="layout">
            <!-- Sidebar summary -->
            <aside class="sidebar">
                <div>
                    <h2>Summary</h2>
                    <div class="metric">
                        <div class="metric-label">Total Hosts</div>
                        <div class="metric-value">{{ hosts|length }}</div>
                        <div class="metric-sub">
                            Across all registered services
                        </div>
                    </div>
                </div>

                <div>
                    <h2>Status</h2>
                    <div class="metric">
                        <div class="metric-label">By health</div>
                        <div class="legend">
                            <div class="legend-pill">
                                <span class="dot dot-online"></span> Free
                            </div>
                            <div class="legend-pill">
                                <span class="dot dot-warning"></span> Allocated
                            </div>
                            <div class="legend-pill">
                                <span class="dot dot-offline"></span> Unavailable
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main content -->
            <section class="main">
                <div class="main-header">
                    <div class="main-header-left">
                        <div class="main-title">Hosts</div>
                        <div class="main-subtitle">
                            Live view of host allocation and status.
                        </div>
                    </div>
                    <div class="main-actions">
                        <input type="search" class="search-input"
                            placeholder="Filter by hostname, owner, or service…" />
                        <button class="btn" type="button" onclick="window.location.reload()">
                            REFRESH
                        </button>
                    </div>
                </div>

                <!-- Scrollable table area -->
                <div class="table-container">
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th data-sort="string">Compute ID</th>
                                    <th data-sort="string">Hostname</th>
                                    <th data-sort="ip">IP</th>
                                    <th data-sort="number">CPUs</th>
                                    <th data-sort="number">CPU Range</th>
                                    <th data-sort="number">Ports Range</th>
                                    <th data-sort="date">Started At</th>
                                    <th data-sort="string">Deployment ID</th>
                                    <th data-sort="string">Owner</th>
                                    <th data-sort="string">Tags</th>
                                    <th data-sort="string">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for compute_id, details in hosts.items() %}
                                {% set s = (details.status or "")|lower %}
                                <tr>
                                    <!-- hostname (key) -->
                                    <td>{{ compute_id }}</td>

                                    <!-- hostname -->
                                    <td>
                                        {% if details.hostname %}
                                        <span class="ip-pill">{{ details.hostname }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>

                                    <!-- ip -->
                                    <td>{{ details.ip if details.ip is not none else "-" }}</td>

                                    <!-- cpu_count -->
                                    <td>
                                        <span class="service-pill">
                                            {% set start = details.cpu_range.split('-')[0] | int %}
                                            {% set end = details.cpu_range.split('-')[1] | int %}
                                            {{ end - start + 1 }}</span>
                                        </span>
                                    </td>

                                    <!-- cpu_range -->
                                    <td>
                                        <span class="service-pill">
                                            <span>{{ details.cpu_range or "-" }}</span>
                                        </span>
                                    </td>

                                    <!-- ports range -->
                                    <td>
                                        <span class="service-pill">
                                            {% set upper = details.cpu_range.split('-')[1] | trim %}
                                            {% if upper in cpu_ports_map %}
                                            {% set base = cpu_ports_map[upper] %}
                                            {{ 20000 + base }}-{{ 20000 + base + 1000 }}
                                            {% else %}
                                            ERROR
                                            {% endif %}
                                        </span>
                                        </span>
                                    </td>


                                    <!-- started_at -->
                                    <td>
                                        {{ details.started_at or "-" }}
                                    </td>

                                    <!-- deployment_id -->
                                    <td>
                                        {% if details.tags.deployment_id %}
                                        <span class="owner-pill">{{ details.tags.deployment_id }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>

                                    <!-- owner -->
                                    <td>
                                        {% if details.tags.owner %}
                                        <span class="owner-pill">{{ details.tags.owner }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>

                                    <!-- tags -->
                                    <td>
                                        <div class="tag-list">
                                            {% for k, v in details.tags.items() %}
                                            {% if k not in ["deployment_id", "owner"] %}
                                            {% if v is sequence and v is not string %}
                                            <span class="owner-pill">{{ k }}:[{{ v | join(',') }}]</span>
                                            {% else %}
                                            <span class="owner-pill">{{ k }}:{{ v }}</span>
                                            {% endif %}
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </td>


                                    <!-- status -->
                                    <td>
                                        {% if "free" in s %}
                                        <span class="status status-online">
                                            <span class="status-dot"></span>
                                            {{ details.status.upper() }}
                                        </span>
                                        {% elif "allocated" in s %}
                                        <span class="status status-warning">
                                            <span class="status-dot"></span>
                                            {{ details.status.upper() }}
                                        </span>
                                        {% else %}
                                        <span class="status status-offline">
                                            <span class="status-dot"></span>
                                            {{ details.status.upper() }}
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">
                    <span>Rendered at {{ rendered_at or "now" }}</span>
                    <span>Κλοηγός dashboard</span>
                </div>
            </section>
        </main>
    </div>
    <script>
        // Auto-refresh every 10 seconds
        setInterval(() => {
            window.location.reload();
        }, 10_000);

        document.addEventListener("DOMContentLoaded", () => {
            const table = document.querySelector("table");
            const tbody = table.querySelector("tbody");
            const allRows = Array.from(tbody.querySelectorAll("tr"));
            const search = document.querySelector(".search-input");
            const headers = Array.from(table.querySelectorAll("thead th"));

            // --- restore state from localStorage ---
            const storedSortIndex = localStorage.getItem("ploigos_sort_index");
            const storedSortDir = localStorage.getItem("ploigos_sort_dir");
            const storedFilter = localStorage.getItem("ploigos_filter");

            let currentSort = { index: null, direction: "asc" };

            if (storedSortIndex !== null && !Number.isNaN(+storedSortIndex)) {
                currentSort.index = +storedSortIndex;
                currentSort.direction = storedSortDir === "desc" ? "desc" : "asc";
            }

            if (search && storedFilter !== null) {
                search.value = storedFilter;
            }

            function getCellText(row, index) {
                return row.children[index].innerText.trim();
            }

            function parseValue(type, value) {
                if (type === "number") {
                    const n = parseFloat(value);
                    return isNaN(n) ? Number.NEGATIVE_INFINITY : n;
                }
                if (type === "date") {
                    const d = new Date(value);
                    return isNaN(d.getTime()) ? 0 : d.getTime();
                }
                if (type === "ip") {
                    // simple IP sort: pad octets
                    return value.split(".")
                        .map(o => o.padStart(3, "0"))
                        .join(".");
                }
                return value.toLowerCase();
            }

            function applyFilterAndSort() {
                const q = (search?.value || "").toLowerCase();

                let rows = allRows.filter(row => {
                    if (!q) return true;
                    const text = row.innerText.toLowerCase();
                    return text.includes(q);
                });

                if (currentSort.index !== null) {
                    const th = headers[currentSort.index];
                    const type = th.dataset.sort || "string";

                    rows.sort((a, b) => {
                        const aVal = parseValue(type, getCellText(a, currentSort.index));
                        const bVal = parseValue(type, getCellText(b, currentSort.index));

                        if (aVal < bVal) return currentSort.direction === "asc" ? -1 : 1;
                        if (aVal > bVal) return currentSort.direction === "asc" ? 1 : -1;
                        return 0;
                    });
                }

                // clear sort classes
                headers.forEach(h => h.classList.remove("sort-asc", "sort-desc"));
                if (currentSort.index !== null) {
                    headers[currentSort.index].classList.add(
                        currentSort.direction === "asc" ? "sort-asc" : "sort-desc"
                    );
                }

                // re-render rows
                tbody.innerHTML = "";
                rows.forEach(r => tbody.appendChild(r));
            }

            // --- wire up filter (and persist it) ---
            if (search) {
                search.addEventListener("input", () => {
                    localStorage.setItem("ploigos_filter", search.value || "");
                    applyFilterAndSort();
                });
            }

            // --- wire up sorting (and persist it) ---
            headers.forEach((th, index) => {
                if (!th.dataset.sort) return;

                th.addEventListener("click", () => {
                    if (currentSort.index === index) {
                        currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
                    } else {
                        currentSort.index = index;
                        currentSort.direction = "asc";
                    }

                    localStorage.setItem("ploigos_sort_index", String(currentSort.index));
                    localStorage.setItem("ploigos_sort_dir", currentSort.direction);

                    applyFilterAndSort();
                });
            });

            // --- initial apply (using restored state, if any) ---
            applyFilterAndSort();
        });
    </script>

</body>

</html>